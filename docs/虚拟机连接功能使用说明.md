# 虚拟机远程连接功能使用说明

## 功能概述

虚拟机远程连接功能是 Hadoop 自动部署系统的第一步，用于配置和测试与 3 台虚拟机的 SSH 连接。该功能提供了友好的图形界面，支持连接配置的持久化存储和自动加载。

## 主要特性

- ✅ **图形化配置界面**：通过 JavaFX 实现的友好用户界面
- ✅ **实时输入验证**：IP 地址格式实时验证，即时反馈
- ✅ **批量连接测试**：同时测试 3 台虚拟机的连接状态
- ✅ **智能故障诊断**：自动识别网络、SSH 服务、认证等不同类型的连接问题
- ✅ **配置持久化**：自动保存和加载连接配置，密码加密存储
- ✅ **密码安全**：支持密码显示/隐藏切换，密码加密存储和脱敏显示
- ✅ **会话管理**：SSH 会话自动缓存和复用，支持自动重连

## 系统要求

### 宿主机环境

- **操作系统**：Windows 10/11（64 位）或 CentOS 7（64 位）
- **JDK 版本**：JDK 1.8 或更高版本
- **JavaFX**：JavaFX 17+
- **Maven**：Maven 3.6+ （用于编译和打包）

### 虚拟机环境

- **操作系统**：CentOS 7 64 位
- **网络配置**：静态 IP 地址
- **SSH 服务**：已安装并启动 sshd 服务
- **用户账号**：具有 SSH 登录权限的用户（建议使用 root）
- **网络连通性**：宿主机与虚拟机网络互通

## 快速开始

### 1. 准备虚拟机环境

#### 1.1 配置静态 IP 地址

在每台虚拟机上编辑网络配置文件：

```bash
# 编辑网络配置文件
vi /etc/sysconfig/network-scripts/ifcfg-ens33

# 修改以下配置
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.10.101  # 虚拟机1，其他虚拟机依次为 .102、.103
NETMASK=255.255.255.0
GATEWAY=192.168.10.2
DNS1=8.8.8.8

# 重启网络服务
systemctl restart network
```

#### 1.2 启动 SSH 服务

```bash
# 启动 SSH 服务
systemctl start sshd

# 设置开机自启
systemctl enable sshd

# 检查服务状态
systemctl status sshd
```

#### 1.3 配置防火墙（可选）

```bash
# 如果启用了防火墙，需要开放 SSH 端口
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload
```

### 2. 编译和运行应用程序

#### 2.1 编译项目

```bash
# 进入项目目录
cd /path/to/Hadoop

# 清理并编译
mvn clean compile

# 打包
mvn package
```

#### 2.2 运行应用程序

```bash
# 方式1：使用 Maven 运行
mvn javafx:run

# 方式2：直接运行 JAR 包
java -jar target/Hadoop-1.0-SNAPSHOT.jar
```

### 3. 配置虚拟机连接

#### 3.1 启动应用程序

双击运行 JAR 包或使用命令行启动，将看到虚拟机连接配置界面。

#### 3.2 输入连接信息

1. **虚拟机 IP 地址**：

   - 虚拟机 1 IP：例如 `192.168.10.101`
   - 虚拟机 2 IP：例如 `192.168.10.102`
   - 虚拟机 3 IP：例如 `192.168.10.103`

2. **登录凭证**：

   - 用户名：例如 `root`
   - 密码：输入对应的密码

3. **实时验证**：
   - 输入 IP 地址时会实时验证格式
   - 格式错误会显示红色边框和错误提示

#### 3.3 测试连接

1. 点击"测试连接"按钮
2. 等待连接测试完成（通常 5-30 秒）
3. 查看每台虚拟机的连接状态：
   - ✓ 绿色：连接成功
   - ✗ 红色：连接失败（查看错误提示）

#### 3.4 处理连接失败

如果连接失败，根据错误提示进行排查：

| 错误类型       | 错误提示                                   | 解决方法                                                                           |
| -------------- | ------------------------------------------ | ---------------------------------------------------------------------------------- |
| 网络不可达     | 网络不通，请检查 IP 地址和网络配置         | 1. 检查 IP 地址是否正确<br>2. 检查虚拟机是否启动<br>3. 检查网络连通性（ping 测试） |
| SSH 服务未启动 | SSH 服务未启动，请在虚拟机中启动 sshd 服务 | 1. 在虚拟机中执行 `systemctl start sshd`<br>2. 检查防火墙设置                      |
| 认证失败       | 用户名或密码错误，请检查登录凭证           | 1. 检查用户名是否正确<br>2. 检查密码是否正确<br>3. 确认用户有 SSH 登录权限         |
| 连接超时       | 连接超时，请检查网络状态和防火墙设置       | 1. 检查网络延迟<br>2. 检查防火墙规则<br>3. 检查 SSH 服务配置                       |

#### 3.5 保存配置

连接测试成功后：

- 配置会自动保存到 `~/.hads/config.json`
- 密码会加密存储
- "下一步"按钮会启用
- 下次启动应用程序时会自动加载配置

### 4. 进入下一步

所有虚拟机连接测试成功后，点击"下一步"按钮进入部署模式选择界面（功能开发中）。

## 功能详解

### IP 地址实时验证

- **验证规则**：IPv4 格式，每个段范围 0-255
- **验证时机**：输入时实时验证
- **反馈方式**：
  - 格式正确：正常边框
  - 格式错误：红色边框 + 错误提示

### 密码显示切换

- **默认状态**：密码以密文（圆点）显示
- **显示密码**：点击"显示"按钮，密码以明文显示
- **隐藏密码**：点击"隐藏"按钮，密码恢复为密文
- **安全性**：密码在日志和配置文件中都会脱敏/加密

### 连接测试流程

1. **输入验证**：验证 IP、用户名、密码格式
2. **网络检测**：检查 IP 是否可达（5 秒超时）
3. **端口检测**：检查 SSH 端口（22）是否开放（5 秒超时）
4. **SSH 连接**：尝试建立 SSH 连接（30 秒超时）
5. **命令验证**：执行测试命令验证连接
6. **会话缓存**：成功后缓存 SSH 会话供后续使用

### 配置持久化

#### 配置文件位置

- **路径**：`~/.hads/config.json`
- **格式**：JSON
- **编码**：UTF-8

#### 配置文件结构

```json
{
  "version": "1.0",
  "lastModified": "2024-01-01T12:00:00",
  "vms": [
    {
      "index": 1,
      "ip": "192.168.10.101",
      "hostname": "hadoop101",
      "username": "root",
      "password": "加密后的密码",
      "sshPort": 22,
      "timeout": 30000
    },
    ...
  ]
}
```

#### 密码加密

- **算法**：AES-256
- **密钥存储**：`~/.hads/keys/`
- **密钥生成**：首次使用时自动生成

### SSH 会话管理

- **会话缓存**：成功建立的 SSH 会话会被缓存
- **会话复用**：后续操作会复用已建立的会话
- **自动重连**：会话断开时自动重连（最多 3 次）
- **资源清理**：应用关闭时自动关闭所有 SSH 会话

## 日志管理

### 日志文件位置

- **路径**：`~/.hads/logs/`
- **文件名**：`hads-YYYY-MM-DD.log`
- **滚动策略**：单文件最大 100MB，保留 10 个文件

### 日志级别

- **DEBUG**：详细的调试信息
- **INFO**：一般信息（默认）
- **WARN**：警告信息
- **ERROR**：错误信息

### 查看日志

```bash
# 查看最新日志
tail -f ~/.hads/logs/hads-$(date +%Y-%m-%d).log

# 搜索错误日志
grep ERROR ~/.hads/logs/*.log
```

## 常见问题

### Q1: 应用程序无法启动

**可能原因：**

- JDK 版本不兼容
- JavaFX 未正确安装
- 缺少依赖库

**解决方法：**

1. 检查 JDK 版本：`java -version`
2. 确认 JavaFX 已安装
3. 重新编译项目：`mvn clean compile`

### Q2: IP 地址验证总是失败

**可能原因：**

- IP 地址格式不正确
- 输入了多余的空格

**解决方法：**

1. 确认 IP 格式为 `xxx.xxx.xxx.xxx`
2. 每个段范围为 0-255
3. 删除多余的空格

### Q3: 连接测试一直超时

**可能原因：**

- 虚拟机未启动
- 网络不通
- 防火墙阻止连接

**解决方法：**

1. 确认虚拟机已启动
2. 在宿主机上 ping 虚拟机 IP
3. 检查防火墙设置
4. 尝试手动 SSH 连接：`ssh root@192.168.10.101`

### Q4: 认证失败

**可能原因：**

- 用户名或密码错误
- 用户没有 SSH 登录权限
- SSH 配置禁止 root 登录

**解决方法：**

1. 确认用户名和密码正确
2. 检查 `/etc/ssh/sshd_config` 中的 `PermitRootLogin` 设置
3. 尝试使用其他用户账号

### Q5: 配置文件损坏

**可能原因：**

- 手动编辑配置文件时格式错误
- 文件写入过程中断

**解决方法：**

1. 删除配置文件：`rm ~/.hads/config.json`
2. 重新启动应用程序
3. 重新配置连接信息

### Q6: 密码无法解密

**可能原因：**

- 加密密钥丢失或损坏
- 配置文件被手动修改

**解决方法：**

1. 删除配置文件和密钥：
   ```bash
   rm ~/.hads/config.json
   rm -rf ~/.hads/keys/
   ```
2. 重新启动应用程序
3. 重新配置连接信息

## 安全建议

1. **密码管理**

   - 使用强密码
   - 定期更换密码
   - 不要在不安全的环境中显示密码

2. **配置文件保护**

   - 设置适当的文件权限：`chmod 600 ~/.hads/config.json`
   - 不要将配置文件分享给他人
   - 定期备份配置文件

3. **SSH 安全**

   - 使用密钥认证代替密码认证（推荐）
   - 禁用 root 远程登录（生产环境）
   - 配置防火墙规则限制 SSH 访问

4. **日志安全**
   - 定期检查日志文件
   - 确保日志中密码已脱敏
   - 不要将日志文件分享给他人

## 已知限制

1. **虚拟机数量**：当前版本固定为 3 台虚拟机
2. **SSH 端口**：当前版本固定为 22 端口
3. **认证方式**：当前版本仅支持密码认证
4. **并发连接**：当前版本不支持同时配置多个集群

## 后续开发计划

- [ ] 支持自定义虚拟机数量
- [ ] 支持自定义 SSH 端口
- [ ] 支持 SSH 密钥认证
- [ ] 支持多集群管理
- [ ] 支持连接配置导入/导出
- [ ] 支持连接历史记录

## 技术支持

如有问题或建议，请联系开发团队或提交 Issue。

---

**版本**：1.0.0  
**更新日期**：2024-01-01  
**作者**：Hadoop 自动部署系统开发团队
